# Инструкции по применению миграции

## Проблемы, которые исправляет миграция

1. **Ошибки RLS (Row Level Security)** - проблемы с политиками доступа
2. **Отсутствующие связи таблиц** - проблемы с foreign keys
3. **Новые функции** - лайки, комментарии, публичная лента

## Применение миграции

### 1. Через Supabase Dashboard (рекомендуется)

1. Откройте [Supabase Dashboard](https://supabase.com/dashboard)
2. Выберите ваш проект
3. Перейдите в раздел **SQL Editor**
4. Создайте новый запрос
5. Скопируйте содержимое файла `supabase/migrations/20250901203900_fix_rls_and_add_features.sql`
6. Выполните запрос

### 2. Через Supabase CLI

```bash
# Убедитесь, что у вас установлен Supabase CLI
supabase --version

# Примените миграцию
supabase db push
```

### 3. Проверка успешности

После применения миграции проверьте:

1. **Таблицы созданы:**
   - `likes` - для лайков/дизлайков
   - `comments` - для комментариев

2. **Политики RLS обновлены:**
   - Профили можно создавать
   - Дружеские журналы доступны
   - Публичные записи видны всем

3. **Индексы созданы** для улучшения производительности

## Что добавляет миграция

### Новые таблицы

#### `likes`
- Хранит лайки и дизлайки пользователей на записи
- Поля: `id`, `user_id`, `entry_id`, `is_like`, `created_at`

#### `comments`
- Хранит комментарии к записям
- Поля: `id`, `user_id`, `entry_id`, `content`, `created_at`, `updated_at`

### Новые функции

#### `get_entry_likes_count(entry_uuid)`
- Возвращает количество лайков и дизлайков для записи

#### `has_user_liked_entry(user_uuid, entry_uuid)`
- Проверяет, лайкнул ли пользователь запись

### Исправления RLS

1. **Профили** - добавлена политика INSERT
2. **Журналы** - добавлен просмотр дружеских журналов
3. **Записи** - добавлен просмотр публичных записей
4. **Дружба** - добавлена политика DELETE

## Возможные проблемы

### 1. Ошибка "relation does not exist"
- Убедитесь, что базовая миграция `20250901203747_3244e4fd-3100-426d-b03f-689984eaa5be.sql` применена

### 2. Ошибка RLS
- Проверьте, что пользователь аутентифицирован
- Убедитесь, что политики применены корректно

### 3. Ошибка foreign key
- Проверьте, что все связанные таблицы существуют
- Убедитесь в корректности связей

## Откат миграции

Если что-то пошло не так:

```sql
-- Удалить новые таблицы
DROP TABLE IF EXISTS public.comments;
DROP TABLE IF EXISTS public.likes;

-- Удалить новые политики
DROP POLICY IF EXISTS "Users can view friends journals" ON public.journals;
DROP POLICY IF EXISTS "Users can view public entries" ON public.entries;

-- Удалить индексы
DROP INDEX IF EXISTS idx_journals_visibility;
DROP INDEX IF EXISTS idx_entries_journal_id;
DROP INDEX IF EXISTS idx_likes_entry_id;
DROP INDEX IF EXISTS idx_comments_entry_id;
DROP INDEX IF EXISTS idx_friendships_status;
```

## После применения миграции

1. **Перезапустите приложение** - новые типы и функции станут доступны
2. **Проверьте функциональность:**
   - Создание профилей
   - Просмотр публичных записей
   - Лайки и комментарии
3. **Тестируйте на разных устройствах** - интерфейс стал адаптивным

## Поддержка

Если возникли проблемы:
1. Проверьте логи в Supabase Dashboard
2. Убедитесь в корректности SQL синтаксиса
3. Проверьте права доступа пользователя
4. Обратитесь к документации Supabase
